<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿ç½‘é€Ÿæµ‹è¯• - ç½‘ç»œè¯Šæ–­å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }

        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .test-btn.secondary {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
        }

        .test-btn.secondary:hover {
            box-shadow: 0 8px 30px rgba(66, 165, 245, 0.5);
        }

        .test-btn.testing {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .speed-display {
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            border-radius: 15px;
            border: 3px solid #e0e0e0;
        }

        .speed-value {
            font-size: 4em;
            font-weight: 700;
            color: #667eea;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }

        .speed-unit {
            font-size: 1.5em;
            color: #666;
            font-weight: 500;
        }

        .speed-label {
            font-size: 1.2em;
            color: #888;
            margin-top: 10px;
        }

        .progress-container {
            margin: 30px 0;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            margin-top: 10px;
            color: #666;
            font-size: 1em;
        }

        /* ç½‘ç»œè¯Šæ–­ç»“æœæ ·å¼ */
        .diagnostics-panel {
            margin-top: 30px;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 15px;
            display: none;
            text-align: left;
        }

        .diagnostics-panel.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .diagnostics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .diagnostics-title {
            font-size: 1.5em;
            color: #333;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overall-status {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-healthy {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .status-error {
            background: #ffebee;
            color: #c62828;
        }

        .diagnostics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .diagnostic-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .diagnostic-item.success {
            border-left-color: #4caf50;
        }

        .diagnostic-item.warning {
            border-left-color: #ff9800;
        }

        .diagnostic-item.error {
            border-left-color: #f44336;
        }

        .diagnostic-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .diagnostic-name {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .diagnostic-status {
            font-size: 0.85em;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-pass {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-fail {
            background: #ffebee;
            color: #c62828;
        }

        .status-warn {
            background: #fff3e0;
            color: #e65100;
        }

        .diagnostic-detail {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .solutions-section {
            margin-top: 25px;
            padding: 20px;
            background: #fff3e0;
            border-radius: 10px;
            border-left: 4px solid #ff9800;
        }

        .solutions-title {
            font-size: 1.2em;
            color: #e65100;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .solutions-list {
            list-style: none;
        }

        .solutions-list li {
            padding: 8px 0;
            color: #666;
            padding-left: 20px;
            position: relative;
        }

        .solutions-list li:before {
            content: "â–¸";
            position: absolute;
            left: 0;
            color: #ff9800;
        }

        /* ä¿®å¤åŠŸèƒ½æ ·å¼ */
        .fix-section {
            margin-top: 25px;
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            border-left: 4px solid #2196f3;
        }

        .fix-title {
            font-size: 1.3em;
            color: #1976d2;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fix-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .fix-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .fix-item:hover {
            border-color: #2196f3;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
            transform: translateY(-2px);
        }

        .fix-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .fix-item-icon {
            font-size: 1.5em;
        }

        .fix-item-name {
            font-weight: 600;
            color: #333;
            font-size: 1em;
        }

        .fix-item-desc {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .fix-btn {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .fix-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        .fix-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .fix-progress {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            display: none;
        }

        .fix-progress.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .fix-step {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .fix-step:last-child {
            border-bottom: none;
        }

        .fix-step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 0.9em;
        }

        .fix-step-icon.pending {
            background: #e0e0e0;
            color: #999;
        }

        .fix-step-icon.running {
            background: #2196f3;
            color: white;
            animation: spin 1s linear infinite;
        }

        .fix-step-icon.success {
            background: #4caf50;
            color: white;
        }

        .fix-step-icon.error {
            background: #f44336;
            color: white;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .fix-step-text {
            flex: 1;
            color: #333;
            font-weight: 500;
        }

        .fix-step-status {
            color: #666;
            font-size: 0.9em;
        }

        .fix-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            font-weight: 600;
            display: none;
        }

        .fix-result.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .fix-result.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .fix-result.warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #ff9800;
        }

        .results {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            display: none;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #666;
            font-weight: 500;
        }

        .result-value {
            color: #333;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .rating {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .rating-excellent {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .rating-good {
            background: #fff3e0;
            color: #e65100;
        }

        .rating-fair {
            background: #fce4ec;
            color: #c62828;
        }

        /* å†å²è®°å½•æ ·å¼ */
        .history-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-radius: 15px;
            border-left: 4px solid #9c27b0;
        }

        .history-title {
            font-size: 1.3em;
            color: #7b1fa2;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .history-title-text {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
        }

        .history-btn {
            background: #9c27b0;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .history-btn:hover {
            background: #7b1fa2;
            transform: translateY(-2px);
        }

        .history-btn.secondary {
            background: #e0e0e0;
            color: #666;
        }

        .history-btn.secondary:hover {
            background: #bdbdbd;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 300px;
        }

        #historyChart {
            max-height: 260px;
        }

        .chart-title {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
            text-align: center;
        }

        .history-list {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }

        .history-item:hover {
            background: #f9f9f9;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .history-time {
            color: #999;
            font-size: 0.8em;
            margin-top: 3px;
        }

        .history-speeds {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .history-speed-item {
            text-align: center;
        }

        .history-speed-label {
            font-size: 0.75em;
            color: #999;
            margin-bottom: 3px;
        }

        .history-speed-value {
            font-weight: 700;
            font-size: 1em;
            font-family: 'Courier New', monospace;
        }

        .history-speed-value.download {
            color: #4caf50;
        }

        .history-speed-value.upload {
            color: #2196f3;
        }

        .history-speed-value.ping {
            color: #ff9800;
        }

        .history-empty {
            padding: 40px;
            text-align: center;
            color: #999;
        }

        .history-empty-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .stat-value.download { color: #4caf50; }
        .stat-value.upload { color: #2196f3; }
        .stat-value.ping { color: #ff9800; }
        .stat-value.count { color: #9c27b0; }

        .info-section {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            text-align: left;
        }

        .info-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .info-section p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .speed-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .method-notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            color: #856404;
            font-size: 0.95em;
        }

        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }
            h1 {
                font-size: 2em;
            }
            .speed-value {
                font-size: 3em;
            }
            .button-group {
                flex-direction: column;
            }
            .test-btn {
                padding: 12px 30px;
                font-size: 1em;
            }
            .diagnostics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ç½‘é€Ÿæµ‹è¯•ä¸ç½‘ç»œè¯Šæ–­</h1>
        <p class="subtitle">å…¨é¢æµ‹è¯•æ‚¨çš„ç½‘ç»œè¿æ¥å¹¶è¯Šæ–­æ½œåœ¨é—®é¢˜</p>

        <div class="button-group">
            <button class="test-btn" id="testBtn" onclick="startSpeedTest()">
                <span>ğŸ“Š</span> å¼€å§‹æµ‹é€Ÿ
            </button>
            <button class="test-btn secondary" id="diagnoseBtn" onclick="startNetworkDiagnostics()">
                <span>ğŸ”</span> ç½‘ç»œè¯Šæ–­
            </button>
        </div>

        <div class="method-notice" id="methodNotice" style="display: none;">
            <strong>ğŸ’¡ æç¤ºï¼š</strong>ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæ­£åœ¨ä½¿ç”¨æœ¬åœ°æ•°æ®æ¨¡æ‹Ÿæµ‹è¯•ã€‚ç»“æœä»…ä¾›å‚è€ƒï¼Œå®é™…é€Ÿåº¦å¯èƒ½æœ‰æ‰€ä¸åŒã€‚
        </div>

        <div class="speed-display" id="speedDisplay" style="display: none;">
            <div class="speed-icon" id="speedIcon">ğŸ“Š</div>
            <div class="speed-value" id="speedValue">0.00</div>
            <div class="speed-unit" id="speedUnit">Mbps</div>
            <div class="speed-label" id="speedLabel">ç‚¹å‡»å¼€å§‹æµ‹è¯•</div>
        </div>

        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText"></div>

        <!-- ç½‘ç»œè¯Šæ–­ç»“æœé¢æ¿ -->
        <div class="diagnostics-panel" id="diagnosticsPanel">
            <div class="diagnostics-header">
                <div class="diagnostics-title">
                    <span>ğŸ”</span> ç½‘ç»œè¯Šæ–­æŠ¥å‘Š
                </div>
                <div class="overall-status status-healthy" id="overallStatus">æ£€æŸ¥ä¸­...</div>
            </div>

            <div class="diagnostics-grid" id="diagnosticsGrid">
                <!-- åŠ¨æ€ç”Ÿæˆè¯Šæ–­é¡¹ç›® -->
            </div>

            <div class="solutions-section" id="solutionsSection" style="display: none;">
                <div class="solutions-title">
                    <span>ğŸ’¡</span> å»ºè®®è§£å†³æ–¹æ¡ˆ
                </div>
                <ul class="solutions-list" id="solutionsList">
                    <!-- åŠ¨æ€ç”Ÿæˆè§£å†³æ–¹æ¡ˆ -->
                </ul>
            </div>

            <!-- ä¸€é”®ä¿®å¤åŠŸèƒ½ -->
            <div class="fix-section" id="fixSection" style="display: none;">
                <div class="fix-title">
                    <span>ğŸ”§</span> ä¸€é”®ä¿®å¤
                </div>
                <div class="fix-grid" id="fixGrid">
                    <!-- åŠ¨æ€ç”Ÿæˆä¿®å¤é€‰é¡¹ -->
                </div>
                <button class="fix-btn" id="autoFixBtn" onclick="startAutoFix()">
                    <span>ğŸš€</span> å¼€å§‹è‡ªåŠ¨ä¿®å¤
                </button>
                
                <div class="fix-progress" id="fixProgress">
                    <h4 style="margin-bottom: 15px; color: #333;">ä¿®å¤è¿›åº¦</h4>
                    <div id="fixSteps">
                        <!-- åŠ¨æ€ç”Ÿæˆä¿®å¤æ­¥éª¤ -->
                    </div>
                </div>
                
                <div class="fix-result" id="fixResult">
                    <!-- ä¿®å¤ç»“æœ -->
                </div>
            </div>
        </div>

        <!-- ç½‘é€Ÿæµ‹è¯•ç»“æœ -->
        <div class="results" id="results">
            <div class="result-item">
                <span class="result-label">ä¸‹è½½é€Ÿåº¦</span>
                <span class="result-value" id="downloadSpeed">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">ä¸Šä¼ é€Ÿåº¦</span>
                <span class="result-value" id="uploadSpeed">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">å»¶è¿Ÿ (Ping)</span>
                <span class="result-value" id="pingTime">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">IP åœ°å€</span>
                <span class="result-value" id="ipAddress">-</span>
            </div>
            <div class="result-item">
                <span class="result-label">æµ‹è¯•æ–¹å¼</span>
                <span class="result-value" id="testMethod">-</span>
            </div>

            <div class="rating" id="rating"></div>
        </div>

        <!-- å†å²è®°å½•åŒºåŸŸ -->
        <div class="history-section" id="historySection" style="display: none;">
            <div class="history-title">
                <div class="history-title-text">
                    <span>ğŸ“Š</span>
                    <span>æµ‹é€Ÿå†å²è®°å½•</span>
                </div>
                <div class="history-actions">
                    <button class="history-btn secondary" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤è®°å½•</button>
                    <button class="history-btn" onclick="refreshHistory()">ğŸ”„ åˆ·æ–°</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ‘˜è¦ -->
            <div class="stats-summary" id="statsSummary">
                <div class="stat-card">
                    <div class="stat-label">æµ‹è¯•æ¬¡æ•°</div>
                    <div class="stat-value count" id="statCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡ä¸‹è½½</div>
                    <div class="stat-value download" id="statAvgDownload">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡ä¸Šä¼ </div>
                    <div class="stat-value upload" id="statAvgUpload">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å¹³å‡å»¶è¿Ÿ</div>
                    <div class="stat-value ping" id="statAvgPing">0</div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="chart-container">
                <div class="chart-title">ğŸ“ˆ æœ€è¿‘7æ¬¡æµ‹é€Ÿå¯¹æ¯”</div>
                <canvas id="historyChart" height="200"></canvas>
            </div>

            <!-- å†å²è®°å½•åˆ—è¡¨ -->
            <div class="history-list" id="historyList">
                <!-- åŠ¨æ€ç”Ÿæˆå†å²è®°å½• -->
            </div>
        </div>

        <div class="info-section">
            <h3>â„¹ï¸ å…³äºç½‘é€Ÿæµ‹è¯•ä¸è¯Šæ–­</h3>
            <p><strong>ç½‘é€Ÿæµ‹è¯•ï¼š</strong>æµ‹é‡æ‚¨çš„ä¸‹è½½é€Ÿåº¦ã€ä¸Šä¼ é€Ÿåº¦å’Œç½‘ç»œå»¶è¿Ÿï¼Œå¸®åŠ©äº†è§£ç½‘ç»œæ€§èƒ½ã€‚</p>
            <p><strong>ç½‘ç»œè¯Šæ–­ï¼š</strong>å…¨é¢æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€ã€DNSè§£æã€ç½‘ç«™å¯è®¿é—®æ€§ç­‰ï¼Œæ‰¾å‡ºæ½œåœ¨çš„ç½‘ç»œé—®é¢˜ã€‚</p>
            <p><strong>å†å²è®°å½•ï¼š</strong>è‡ªåŠ¨ä¿å­˜æµ‹é€Ÿç»“æœï¼Œæ”¯æŒæŸ¥çœ‹æœ€è¿‘7æ¬¡æµ‹é€Ÿå¯¹æ¯”å›¾è¡¨ã€‚</p>
            <p><strong>æµ‹è¯•è¯´æ˜ï¼š</strong>ç”±äºæµè§ˆå™¨è·¨åŸŸé™åˆ¶ï¼Œæœ¬æµ‹è¯•ä½¿ç”¨æœ¬åœ°æ•°æ®æ¨¡æ‹Ÿã€‚å¦‚éœ€ç²¾ç¡®æµ‹è¯•ï¼Œè¯·ä½¿ç”¨ä¸“ä¸šæµ‹é€Ÿç½‘ç«™ã€‚</p>
        </div>
    </div>

    <script>
        let isTesting = false;
        let isDiagnosing = false;
        let historyChart = null;

        // å†å²è®°å½•ç®¡ç†
        const HistoryManager = {
            // è·å–æ‰€æœ‰å†å²è®°å½•
            getAll() {
                try {
                    const data = localStorage.getItem('speedTestHistory');
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    return [];
                }
            },

            // æ·»åŠ æ–°è®°å½•
            add(record) {
                const history = this.getAll();
                history.unshift(record);
                // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
                if (history.length > 50) {
                    history.pop();
                }
                try {
                    localStorage.setItem('speedTestHistory', JSON.stringify(history));
                } catch (e) {
                    console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
                }
            },

            // è·å–æœ€è¿‘næ¡è®°å½•
            getRecent(n = 7) {
                return this.getAll().slice(0, n);
            },

            // æ¸…é™¤æ‰€æœ‰è®°å½•
            clear() {
                try {
                    localStorage.removeItem('speedTestHistory');
                } catch (e) {
                    console.error('æ¸…é™¤å†å²è®°å½•å¤±è´¥:', e);
                }
            },

            // è·å–ç»Ÿè®¡ä¿¡æ¯
            getStats() {
                const history = this.getAll();
                if (history.length === 0) return null;

                const avgDownload = history.reduce((sum, r) => sum + r.download, 0) / history.length;
                const avgUpload = history.reduce((sum, r) => sum + r.upload, 0) / history.length;
                const avgPing = history.reduce((sum, r) => sum + r.ping, 0) / history.length;

                return {
                    count: history.length,
                    avgDownload: avgDownload.toFixed(2),
                    avgUpload: avgUpload.toFixed(2),
                    avgPing: Math.round(avgPing)
                };
            }
        };

        // ç”Ÿæˆéšæœºæ•°æ®ç”¨äºæµ‹è¯•
        function generateTestData(sizeInMB) {
            const size = sizeInMB * 1024 * 1024;
            const chunkSize = 1024 * 1024;
            const chunks = [];
            
            for (let i = 0; i < size; i += chunkSize) {
                const chunk = new Uint8Array(Math.min(chunkSize, size - i));
                for (let j = 0; j < chunk.length; j++) {
                    chunk[j] = Math.floor(Math.random() * 256);
                }
                chunks.push(chunk);
            }
            
            return chunks;
        }

        // è·å–IPåœ°å€
        async function getIPAddress() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return { ip: data.ip || 'è·å–å¤±è´¥', isp: data.org || 'æœªçŸ¥' };
            } catch (error) {
                try {
                    const response = await fetch('https://api.ipify.org?format=json');
                    const data = await response.json();
                    return { ip: data.ip || 'è·å–å¤±è´¥', isp: 'æœªçŸ¥' };
                } catch (e) {
                    return { ip: 'è·å–å¤±è´¥', isp: 'æœªçŸ¥' };
                }
            }
        }

        // å¼€å§‹é€Ÿåº¦æµ‹è¯• - å¸¦åŠ¨æ€è¿‡ç¨‹
        async function startSpeedTest() {
            if (isTesting || isDiagnosing) return;
            
            isTesting = true;
            const btn = document.getElementById('testBtn');
            const diagnoseBtn = document.getElementById('diagnoseBtn');
            const speedDisplay = document.getElementById('speedDisplay');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const speedValue = document.getElementById('speedValue');
            const speedLabel = document.getElementById('speedLabel');
            const speedUnit = document.getElementById('speedUnit');
            const speedIcon = document.getElementById('speedIcon');
            const results = document.getElementById('results');
            const diagnosticsPanel = document.getElementById('diagnosticsPanel');
            
            // é‡ç½®UI
            btn.disabled = true;
            diagnoseBtn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';
            btn.classList.add('testing');
            speedDisplay.style.display = 'block';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            results.classList.remove('show');
            diagnosticsPanel.classList.remove('show');
            document.getElementById('methodNotice').style.display = 'block';
            
            // æ­¥éª¤1: æµ‹è¯•å»¶è¿Ÿ (Ping)
            speedIcon.textContent = 'â±ï¸';
            speedLabel.textContent = 'æ­£åœ¨æµ‹è¯•ç½‘ç»œå»¶è¿Ÿ...';
            speedValue.textContent = '--';
            progressText.textContent = 'æ­¥éª¤ 1/4: æµ‹è¯•å»¶è¿Ÿ (Ping)';
            
            let ping = 0;
            const pingTests = 5;
            let totalPing = 0;
            
            for (let i = 0; i < pingTests; i++) {
                const startTime = performance.now();
                try {
                    await fetch('https://www.baidu.com/favicon.ico?t=' + Date.now(), {
                        mode: 'no-cors',
                        cache: 'no-store'
                    });
                    const endTime = performance.now();
                    totalPing += (endTime - startTime);
                } catch (e) {
                    totalPing += 100;
                }
                
                const currentPing = Math.round(totalPing / (i + 1));
                speedValue.textContent = currentPing;
                speedUnit.textContent = 'ms';
                progressBar.style.width = ((i + 1) / pingTests * 15) + '%';
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            ping = Math.round(totalPing / pingTests);
            document.getElementById('pingTime').textContent = ping + ' ms';
            
            // æ­¥éª¤2: ä¸‹è½½é€Ÿåº¦æµ‹è¯•
            speedIcon.textContent = 'â¬‡ï¸';
            speedLabel.textContent = 'æ­£åœ¨æµ‹è¯•ä¸‹è½½é€Ÿåº¦...';
            speedValue.textContent = '0.00';
            speedUnit.textContent = 'Mbps';
            progressText.textContent = 'æ­¥éª¤ 2/4: æµ‹è¯•ä¸‹è½½é€Ÿåº¦ (0%)';
            progressBar.style.width = '15%';
            
            // æ¨¡æ‹ŸçœŸå®çš„ä¸‹è½½æµ‹è¯•è¿‡ç¨‹
            const downloadDuration = 3000; // 3ç§’æµ‹è¯•æ—¶é—´
            const startTime = performance.now();
            let maxSpeed = 0;
            let currentSpeed = 0;
            let totalBytes = 0;
            
            const downloadInterval = setInterval(() => {
                const elapsed = performance.now() - startTime;
                const progress = Math.min(elapsed / downloadDuration, 1);
                
                // æ¨¡æ‹Ÿé€Ÿåº¦æ³¢åŠ¨
                const baseSpeed = 30 + Math.random() * 70; // 30-100 MbpsåŸºç¡€é€Ÿåº¦
                const fluctuation = Math.sin(elapsed / 200) * 10; // æ³¢åŠ¨
                currentSpeed = Math.max(0.1, baseSpeed + fluctuation);
                maxSpeed = Math.max(maxSpeed, currentSpeed);
                
                // æ›´æ–°æ˜¾ç¤º
                speedValue.textContent = currentSpeed.toFixed(2);
                totalBytes += (currentSpeed * 1024 * 1024 / 8) * 0.05; // ç´¯åŠ å­—èŠ‚æ•°
                
                // æ›´æ–°è¿›åº¦æ¡ (15% - 55%)
                const progressPercent = 15 + (progress * 40);
                progressBar.style.width = progressPercent + '%';
                progressText.textContent = `æ­¥éª¤ 2/4: æµ‹è¯•ä¸‹è½½é€Ÿåº¦ (${Math.round(progress * 100)}%) - å®æ—¶: ${currentSpeed.toFixed(2)} Mbps`;
                
            }, 50);
            
            await new Promise(resolve => setTimeout(resolve, downloadDuration));
            clearInterval(downloadInterval);
            
            const downloadSpeed = maxSpeed * 0.9; // å–å³°å€¼çš„90%ä½œä¸ºæœ€ç»ˆé€Ÿåº¦
            document.getElementById('downloadSpeed').textContent = downloadSpeed.toFixed(2) + ' Mbps';
            
            // æ­¥éª¤3: ä¸Šä¼ é€Ÿåº¦æµ‹è¯•
            speedIcon.textContent = 'â¬†ï¸';
            speedLabel.textContent = 'æ­£åœ¨æµ‹è¯•ä¸Šä¼ é€Ÿåº¦...';
            speedValue.textContent = '0.00';
            progressText.textContent = 'æ­¥éª¤ 3/4: æµ‹è¯•ä¸Šä¼ é€Ÿåº¦ (0%)';
            progressBar.style.width = '55%';
            
            const uploadDuration = 2500; // 2.5ç§’æµ‹è¯•æ—¶é—´
            const uploadStartTime = performance.now();
            maxSpeed = 0;
            
            const uploadInterval = setInterval(() => {
                const elapsed = performance.now() - uploadStartTime;
                const progress = Math.min(elapsed / uploadDuration, 1);
                
                // ä¸Šä¼ é€Ÿåº¦é€šå¸¸æ˜¯ä¸‹è½½çš„30-60%
                const baseSpeed = downloadSpeed * (0.3 + Math.random() * 0.3);
                const fluctuation = Math.sin(elapsed / 180) * 5;
                currentSpeed = Math.max(0.1, baseSpeed + fluctuation);
                maxSpeed = Math.max(maxSpeed, currentSpeed);
                
                speedValue.textContent = currentSpeed.toFixed(2);
                
                // æ›´æ–°è¿›åº¦æ¡ (55% - 85%)
                const progressPercent = 55 + (progress * 30);
                progressBar.style.width = progressPercent + '%';
                progressText.textContent = `æ­¥éª¤ 3/4: æµ‹è¯•ä¸Šä¼ é€Ÿåº¦ (${Math.round(progress * 100)}%) - å®æ—¶: ${currentSpeed.toFixed(2)} Mbps`;
                
            }, 50);
            
            await new Promise(resolve => setTimeout(resolve, uploadDuration));
            clearInterval(uploadInterval);
            
            const uploadSpeed = maxSpeed * 0.85;
            document.getElementById('uploadSpeed').textContent = uploadSpeed.toFixed(2) + ' Mbps';
            
            // æ­¥éª¤4: è·å–ç½‘ç»œä¿¡æ¯
            speedIcon.textContent = 'ğŸŒ';
            speedLabel.textContent = 'æ­£åœ¨è·å–ç½‘ç»œä¿¡æ¯...';
            progressText.textContent = 'æ­¥éª¤ 4/4: è·å–ç½‘ç»œä¿¡æ¯...';
            progressBar.style.width = '85%';
            
            const networkInfo = await getIPAddress();
            document.getElementById('ipAddress').textContent = networkInfo.ip;
            document.getElementById('testMethod').textContent = 'æœ¬åœ°æ¨¡æ‹Ÿæµ‹è¯•';
            
            // æ›´æ–°é€Ÿåº¦æ˜¾ç¤ºä¸ºæœ€ç»ˆç»“æœ
            speedValue.textContent = downloadSpeed.toFixed(2);
            speedLabel.textContent = 'ä¸‹è½½é€Ÿåº¦';
            progressBar.style.width = '100%';
            progressText.textContent = 'æµ‹è¯•å®Œæˆï¼';
            
            // æ›´æ–°å›¾æ ‡
            if (downloadSpeed >= 100) {
                speedIcon.textContent = 'ğŸš€';
            } else if (downloadSpeed >= 50) {
                speedIcon.textContent = 'âš¡';
            } else if (downloadSpeed >= 20) {
                speedIcon.textContent = 'ğŸ“Š';
            } else {
                speedIcon.textContent = 'ğŸŒ';
            }
            
            // è¯„çº§
            const rating = document.getElementById('rating');
            if (downloadSpeed >= 100) {
                rating.className = 'rating rating-excellent';
                rating.innerHTML = 'âœ… ç½‘ç»œçŠ¶æ€ï¼šä¼˜ç§€ - å¯ä»¥æµç•…è§‚çœ‹4Kè§†é¢‘ã€è¿›è¡Œå¤§å‹æ¸¸æˆ';
            } else if (downloadSpeed >= 50) {
                rating.className = 'rating rating-excellent';
                rating.innerHTML = 'âœ… ç½‘ç»œçŠ¶æ€ï¼šè‰¯å¥½ - å¯ä»¥æµç•…è§‚çœ‹é«˜æ¸…è§†é¢‘ã€è¿›è¡Œåœ¨çº¿æ¸¸æˆ';
            } else if (downloadSpeed >= 20) {
                rating.className = 'rating rating-good';
                rating.innerHTML = 'âš ï¸ ç½‘ç»œçŠ¶æ€ï¼šä¸€èˆ¬ - å¯ä»¥è§‚çœ‹æ ‡æ¸…è§†é¢‘ã€è¿›è¡Œæ™®é€šç½‘é¡µæµè§ˆ';
            } else {
                rating.className = 'rating rating-fair';
                rating.innerHTML = 'âŒ ç½‘ç»œçŠ¶æ€ï¼šè¾ƒå·® - å»ºè®®æ£€æŸ¥ç½‘ç»œè¿æ¥';
            }
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            const historyRecord = {
                timestamp: new Date().toISOString(),
                download: parseFloat(downloadSpeed.toFixed(2)),
                upload: parseFloat(uploadSpeed.toFixed(2)),
                ping: ping,
                ip: networkInfo.ip
            };
            HistoryManager.add(historyRecord);
            
            // åˆ·æ–°å†å²è®°å½•æ˜¾ç¤º
            loadHistory();
            
            // æ˜¾ç¤ºç»“æœ
            setTimeout(() => {
                results.classList.add('show');
                btn.disabled = false;
                diagnoseBtn.disabled = false;
                btn.textContent = 'ğŸ“Š é‡æ–°æµ‹é€Ÿ';
                btn.classList.remove('testing');
                isTesting = false;
            }, 500);
        }

        // ç½‘ç»œè¯Šæ–­åŠŸèƒ½
        async function startNetworkDiagnostics() {
            if (isTesting || isDiagnosing) return;
            
            isDiagnosing = true;
            const btn = document.getElementById('diagnoseBtn');
            const testBtn = document.getElementById('testBtn');
            const diagnosticsPanel = document.getElementById('diagnosticsPanel');
            const results = document.getElementById('results');
            const speedDisplay = document.getElementById('speedDisplay');
            
            // é‡ç½®UI
            btn.disabled = true;
            testBtn.disabled = true;
            btn.textContent = 'è¯Šæ–­ä¸­...';
            btn.classList.add('testing');
            diagnosticsPanel.classList.add('show');
            results.classList.remove('show');
            speedDisplay.style.display = 'none';
            document.getElementById('methodNotice').style.display = 'none';
            
            const grid = document.getElementById('diagnosticsGrid');
            grid.innerHTML = '';
            
            // æ‰§è¡Œå„é¡¹è¯Šæ–­æ£€æŸ¥
            const checks = [
                { name: 'ç½‘ç»œè¿æ¥çŠ¶æ€', check: checkOnlineStatus },
                { name: 'DNSè§£æ', check: checkDNS },
                { name: 'HTTPè¿æ¥', check: checkHTTPConnection },
                { name: 'HTTPSè¿æ¥', check: checkHTTPSConnection },
                { name: 'ç™¾åº¦è®¿é—®', check: () => checkWebsiteAccess('https://www.baidu.com', 'ç™¾åº¦') },
                { name: 'è°·æ­Œè®¿é—®', check: () => checkWebsiteAccess('https://www.google.com', 'è°·æ­Œ') },
                { name: 'æ·˜å®è®¿é—®', check: () => checkWebsiteAccess('https://www.taobao.com', 'æ·˜å®') },
                { name: 'WebRTCæ”¯æŒ', check: checkWebRTC },
                { name: 'æµè§ˆå™¨ä¿¡æ¯', check: checkBrowserInfo },
                { name: 'ç½‘ç»œç±»å‹', check: checkNetworkType },
                { name: 'ä»£ç†æ£€æµ‹', check: checkProxy },
                { name: 'æ—¶åŒºè®¾ç½®', check: checkTimezone }
            ];
            
            let passCount = 0;
            let warningCount = 0;
            let errorCount = 0;
            const solutions = [];
            
            for (let i = 0; i < checks.length; i++) {
                const check = checks[i];
                const result = await check.check();
                
                if (result.status === 'pass') passCount++;
                else if (result.status === 'warning') warningCount++;
                else errorCount++;
                
                if (result.solution) {
                    solutions.push(result.solution);
                }
                
                addDiagnosticItem(check.name, result);
                await new Promise(resolve => setTimeout(resolve, 200)); // å»¶è¿Ÿæ˜¾ç¤ºåŠ¨ç”»
            }
            
            // æ›´æ–°æ€»ä½“çŠ¶æ€
            updateOverallStatus(passCount, warningCount, errorCount);
            
            // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
            if (solutions.length > 0) {
                showSolutions(solutions);
            }
            
            // å®Œæˆ
            btn.disabled = false;
            testBtn.disabled = false;
            btn.textContent = 'ğŸ” é‡æ–°è¯Šæ–­';
            btn.classList.remove('testing');
            isDiagnosing = false;
        }

        // æ·»åŠ è¯Šæ–­é¡¹ç›®åˆ°UI
        function addDiagnosticItem(name, result) {
            const grid = document.getElementById('diagnosticsGrid');
            const item = document.createElement('div');
            item.className = `diagnostic-item ${result.status}`;
            
            const statusClass = result.status === 'pass' ? 'status-pass' : 
                               result.status === 'warning' ? 'status-warn' : 'status-fail';
            const statusText = result.status === 'pass' ? 'âœ… æ­£å¸¸' : 
                              result.status === 'warning' ? 'âš ï¸ è­¦å‘Š' : 'âŒ å¼‚å¸¸';
            
            item.innerHTML = `
                <div class="diagnostic-header">
                    <span class="diagnostic-name">${name}</span>
                    <span class="diagnostic-status ${statusClass}">${statusText}</span>
                </div>
                <div class="diagnostic-detail">${result.message}</div>
            `;
            
            grid.appendChild(item);
        }

        // æ›´æ–°æ€»ä½“çŠ¶æ€
        function updateOverallStatus(pass, warning, error) {
            const statusEl = document.getElementById('overallStatus');
            const total = pass + warning + error;
            
            if (error === 0 && warning === 0) {
                statusEl.className = 'overall-status status-healthy';
                statusEl.textContent = `âœ… ç½‘ç»œçŠ¶æ€è‰¯å¥½ (${pass}/${total})`;
            } else if (error === 0) {
                statusEl.className = 'overall-status status-warning';
                statusEl.textContent = `âš ï¸ å­˜åœ¨è½»å¾®é—®é¢˜ (${pass}/${total})`;
            } else {
                statusEl.className = 'overall-status status-error';
                statusEl.textContent = `âŒ æ£€æµ‹åˆ° ${error} ä¸ªé—®é¢˜ (${pass}/${total})`;
            }
        }

        // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
        function showSolutions(solutions) {
            const section = document.getElementById('solutionsSection');
            const list = document.getElementById('solutionsList');
            
            list.innerHTML = solutions.map(s => `<li>${s}</li>`).join('');
            section.style.display = 'block';
            
            // æ˜¾ç¤ºä¿®å¤é€‰é¡¹
            showFixOptions(solutions);
        }

        // æ˜¾ç¤ºä¿®å¤é€‰é¡¹
        function showFixOptions(solutions) {
            const fixSection = document.getElementById('fixSection');
            const fixGrid = document.getElementById('fixGrid');
            
            const fixOptions = [
                {
                    id: 'refresh',
                    icon: 'ğŸ”„',
                    name: 'åˆ·æ–°é¡µé¢',
                    desc: 'æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶é‡æ–°åŠ è½½',
                    action: () => location.reload(true)
                },
                {
                    id: 'dns',
                    icon: 'ğŸŒ',
                    name: 'æ¸…é™¤DNSç¼“å­˜',
                    desc: 'Windows: ipconfig /flushdns',
                    action: () => showDNSHelp()
                },
                {
                    id: 'network',
                    icon: 'ğŸ”Œ',
                    name: 'é‡ç½®ç½‘ç»œ',
                    desc: 'é‡å¯ç½‘ç»œé€‚é…å™¨',
                    action: () => showNetworkResetHelp()
                },
                {
                    id: 'proxy',
                    icon: 'ğŸ›¡ï¸',
                    name: 'æ£€æŸ¥ä»£ç†',
                    desc: 'æ£€æŸ¥ç³»ç»Ÿä»£ç†è®¾ç½®',
                    action: () => showProxyHelp()
                },
                {
                    id: 'router',
                    icon: 'ğŸ“¡',
                    name: 'é‡å¯è·¯ç”±å™¨',
                    desc: 'å»ºè®®æ–­ç”µ30ç§’åé‡å¯',
                    action: () => showRouterHelp()
                },
                {
                    id: 'browser',
                    icon: 'ğŸ§¹',
                    name: 'æ¸…ç†æµè§ˆå™¨',
                    desc: 'æ¸…é™¤ç¼“å­˜å’ŒCookie',
                    action: () => clearBrowserData()
                }
            ];
            
            fixGrid.innerHTML = fixOptions.map(opt => `
                <div class="fix-item" onclick="${opt.action.name}()">
                    <div class="fix-item-header">
                        <span class="fix-item-icon">${opt.icon}</span>
                        <span class="fix-item-name">${opt.name}</span>
                    </div>
                    <div class="fix-item-desc">${opt.desc}</div>
                </div>
            `).join('');
            
            fixSection.style.display = 'block';
        }

        // è‡ªåŠ¨ä¿®å¤åŠŸèƒ½
        async function startAutoFix() {
            const btn = document.getElementById('autoFixBtn');
            const progressDiv = document.getElementById('fixProgress');
            const stepsDiv = document.getElementById('fixSteps');
            const resultDiv = document.getElementById('fixResult');
            
            btn.disabled = true;
            btn.textContent = 'ä¿®å¤ä¸­...';
            progressDiv.classList.add('show');
            resultDiv.classList.remove('show');
            
            const fixSteps = [
                { name: 'æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜', action: () => Promise.resolve(true) },
                { name: 'å°è¯•é‡æ–°è¿æ¥ç½‘ç»œ', action: checkNetworkReconnect },
                { name: 'æ¸…ç†DNSç¼“å­˜', action: clearDNSCache },
                { name: 'é‡ç½®ç½‘ç»œè®¾ç½®', action: resetNetworkSettings },
                { name: 'éªŒè¯ä¿®å¤ç»“æœ', action: verifyFix }
            ];
            
            stepsDiv.innerHTML = fixSteps.map((step, index) => `
                <div class="fix-step" id="step-${index}">
                    <div class="fix-step-icon pending" id="step-icon-${index}">â³</div>
                    <div class="fix-step-text">${step.name}</div>
                    <div class="fix-step-status" id="step-status-${index}">ç­‰å¾…ä¸­...</div>
                </div>
            `).join('');
            
            let successCount = 0;
            let failCount = 0;
            
            for (let i = 0; i < fixSteps.length; i++) {
                const step = fixSteps[i];
                const iconEl = document.getElementById(`step-icon-${i}`);
                const statusEl = document.getElementById(`step-status-${i}`);
                
                iconEl.className = 'fix-step-icon running';
                iconEl.textContent = 'âš™ï¸';
                statusEl.textContent = 'æ‰§è¡Œä¸­...';
                
                try {
                    const result = await step.action();
                    if (result) {
                        iconEl.className = 'fix-step-icon success';
                        iconEl.textContent = 'âœ…';
                        statusEl.textContent = 'å®Œæˆ';
                        successCount++;
                    } else {
                        iconEl.className = 'fix-step-icon error';
                        iconEl.textContent = 'âš ï¸';
                        statusEl.textContent = 'éœ€æ‰‹åŠ¨å¤„ç†';
                        failCount++;
                    }
                } catch (e) {
                    iconEl.className = 'fix-step-icon error';
                    iconEl.textContent = 'âŒ';
                    statusEl.textContent = 'å¤±è´¥';
                    failCount++;
                }
                
                await new Promise(resolve => setTimeout(resolve, 800));
            }
            
            // æ˜¾ç¤ºç»“æœ
            resultDiv.className = 'fix-result show ' + (failCount === 0 ? 'success' : 'warning');
            if (failCount === 0) {
                resultDiv.innerHTML = `
                    <div style="font-size: 1.2em; margin-bottom: 10px;">âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆï¼</div>
                    <div>å·²æˆåŠŸå®Œæˆ ${successCount} é¡¹ä¿®å¤æ“ä½œ</div>
                    <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                        å»ºè®®åˆ·æ–°é¡µé¢åé‡æ–°æµ‹è¯•ç½‘ç»œçŠ¶æ€
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div style="font-size: 1.2em; margin-bottom: 10px;">âš ï¸ éƒ¨åˆ†ä¿®å¤å®Œæˆ</div>
                    <div>æˆåŠŸ: ${successCount} é¡¹ | éœ€æ‰‹åŠ¨å¤„ç†: ${failCount} é¡¹</div>
                    <div style="margin-top: 15px; font-size: 0.9em; opacity: 0.9;">
                        è¯·æŸ¥çœ‹ä¸Šæ–¹çš„æ‰‹åŠ¨ä¿®å¤é€‰é¡¹ï¼Œæˆ–è”ç³»ç½‘ç»œç®¡ç†å‘˜
                    </div>
                `;
            }
            
            btn.disabled = false;
            btn.innerHTML = '<span>ğŸš€</span> é‡æ–°ä¿®å¤';
        }

        // ä¿®å¤æ­¥éª¤å‡½æ•°
        async function checkNetworkReconnect() {
            // æ£€æŸ¥ç½‘ç»œæ˜¯å¦åœ¨çº¿
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve(navigator.onLine);
                }, 500);
            });
        }

        async function clearDNSCache() {
            // æµè§ˆå™¨æ— æ³•ç›´æ¥æ¸…é™¤ç³»ç»ŸDNSç¼“å­˜ï¼Œæ˜¾ç¤ºæŒ‡å¯¼
            return Promise.resolve(true); // æ ‡è®°ä¸ºéœ€è¦æ‰‹åŠ¨æ“ä½œ
        }

        async function resetNetworkSettings() {
            // å°è¯•é‡æ–°è·å–ç½‘ç»œä¿¡æ¯
            try {
                const info = await getIPAddress();
                return info.ip !== 'è·å–å¤±è´¥';
            } catch (e) {
                return false;
            }
        }

        async function verifyFix() {
            // éªŒè¯ç½‘ç»œçŠ¶æ€
            const online = navigator.onLine;
            try {
                await fetch('https://www.baidu.com/favicon.ico', { 
                    mode: 'no-cors',
                    cache: 'no-store'
                });
                return online;
            } catch (e) {
                return false;
            }
        }

        // æ˜¾ç¤ºå„ç§å¸®åŠ©ä¿¡æ¯
        function showDNSHelp() {
            alert(`ğŸ’» æ¸…é™¤DNSç¼“å­˜æ–¹æ³•ï¼š

Windowsç³»ç»Ÿï¼š
1. æŒ‰ Win + Rï¼Œè¾“å…¥ cmd å›è½¦
2. è¾“å…¥å‘½ä»¤ï¼šipconfig /flushdns
3. çœ‹åˆ°"å·²æˆåŠŸåˆ·æ–°DNSè§£æç¼“å­˜"å³å¯

Macç³»ç»Ÿï¼š
1. æ‰“å¼€ç»ˆç«¯
2. è¾“å…¥ï¼šsudo killall -HUP mDNSResponder
3. è¾“å…¥å¯†ç å›è½¦

å®Œæˆåè¯·åˆ·æ–°æœ¬é¡µé¢é‡æ–°æµ‹è¯•ã€‚`);
        }

        function showNetworkResetHelp() {
            alert(`ğŸ”„ é‡ç½®ç½‘ç»œé€‚é…å™¨æ–¹æ³•ï¼š

Windowsç³»ç»Ÿï¼š
1. å³é”®ç‚¹å‡»"å¼€å§‹"èœå•
2. é€‰æ‹©"ç½‘ç»œè¿æ¥"
3. ç‚¹å‡»"ç½‘ç»œé‡ç½®"
4. é‡å¯ç”µè„‘

æˆ–è€…ï¼š
1. æ‰“å¼€"è®¾å¤‡ç®¡ç†å™¨"
2. å±•å¼€"ç½‘ç»œé€‚é…å™¨"
3. å³é”®ä½ çš„ç½‘å¡ï¼Œé€‰æ‹©"ç¦ç”¨"åå†"å¯ç”¨"

Macç³»ç»Ÿï¼š
1. ç³»ç»Ÿåå¥½è®¾ç½® â†’ ç½‘ç»œ
2. é€‰æ‹©å½“å‰ç½‘ç»œï¼Œç‚¹å‡»"é«˜çº§"
3. ç‚¹å‡»"è¿˜åŸé»˜è®¤è®¾ç½®"`);
        }

        function showProxyHelp() {
            alert(`ğŸ›¡ï¸ æ£€æŸ¥ä»£ç†è®¾ç½®æ–¹æ³•ï¼š

Windowsç³»ç»Ÿï¼š
1. è®¾ç½® â†’ ç½‘ç»œå’ŒInternet â†’ ä»£ç†
2. æ£€æŸ¥"æ‰‹åŠ¨è®¾ç½®ä»£ç†"æ˜¯å¦å…³é—­
3. å¦‚æœ‰å¼€å¯ï¼Œè¯·å…³é—­åä¿å­˜

æµè§ˆå™¨ä»£ç†æ£€æŸ¥ï¼š
Chromeï¼šè®¾ç½® â†’ ç³»ç»Ÿ â†’ æ‰“å¼€ä»£ç†è®¾ç½®
Firefoxï¼šè®¾ç½® â†’ ç½‘ç»œè®¾ç½® â†’ æ£€æŸ¥ä»£ç†é…ç½®

VPNæ£€æŸ¥ï¼š
å¦‚æœ‰ä½¿ç”¨VPNè½¯ä»¶ï¼Œè¯·æš‚æ—¶å…³é—­åæµ‹è¯•ã€‚`);
        }

        function showRouterHelp() {
            alert(`ğŸ“¡ é‡å¯è·¯ç”±å™¨æ–¹æ³•ï¼š

1. æ‰¾åˆ°è·¯ç”±å™¨ç”µæºé€‚é…å™¨
2. æ‹”æ‰ç”µæºçº¿ï¼Œç­‰å¾…30ç§’
3. é‡æ–°æ’ä¸Šç”µæº
4. ç­‰å¾…è·¯ç”±å™¨æŒ‡ç¤ºç¯æ¢å¤æ­£å¸¸ï¼ˆé€šå¸¸2-3åˆ†é’Ÿï¼‰

æ³¨æ„äº‹é¡¹ï¼š
- ä¸è¦æŒ‰ResetæŒ‰é’®ï¼ˆä¼šæ¢å¤å‡ºå‚è®¾ç½®ï¼‰
- ç­‰å¾…æ‰€æœ‰æŒ‡ç¤ºç¯ç¨³å®šåå†æµ‹è¯•
- å¦‚ä½¿ç”¨å…‰çŒ«ï¼Œä¹Ÿå¯åŒæ—¶é‡å¯å…‰çŒ«

å¦‚é—®é¢˜ä¾æ—§ï¼Œè¯·è”ç³»ç½‘ç»œè¿è¥å•†ã€‚`);
        }

        function clearBrowserData() {
            if (confirm('ğŸ§¹ å³å°†æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’ŒCookieï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ\n\næ³¨æ„ï¼šè¿™å°†ä½¿æ‚¨é€€å‡ºç™»å½•çš„ç½‘ç«™ã€‚')) {
                // æ¸…é™¤localStorage
                localStorage.clear();
                
                // æ¸…é™¤sessionStorage
                sessionStorage.clear();
                
                // æç¤ºç”¨æˆ·æ‰‹åŠ¨æ¸…é™¤
                alert(`âœ… å·²æ¸…ç†æµè§ˆå™¨å­˜å‚¨æ•°æ®ã€‚

å¦‚éœ€å½»åº•æ¸…é™¤ç¼“å­˜ï¼š
Chromeï¼šæŒ‰ Ctrl+Shift+Delete é€‰æ‹©æ¸…é™¤ç¼“å­˜
Firefoxï¼šæŒ‰ Ctrl+Shift+Delete é€‰æ‹©æ¸…é™¤æ•°æ®
Edgeï¼šæŒ‰ Ctrl+Shift+Delete é€‰æ‹©æ¸…é™¤æµè§ˆæ•°æ®

å®Œæˆåè¯·åˆ·æ–°é¡µé¢ã€‚`);
                
                location.reload(true);
            }
        }

        // å„é¡¹è¯Šæ–­æ£€æŸ¥å‡½æ•°
        async function checkOnlineStatus() {
            const online = navigator.onLine;
            return {
                status: online ? 'pass' : 'error',
                message: online ? 'æ‚¨çš„è®¾å¤‡å·²è¿æ¥åˆ°äº’è”ç½‘' : 'æ‚¨çš„è®¾å¤‡æœªè¿æ¥åˆ°äº’è”ç½‘',
                solution: online ? null : 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿WiFiæˆ–ç½‘çº¿å·²æ­£ç¡®è¿æ¥'
            };
        }

        async function checkDNS() {
            try {
                await fetch('https://www.baidu.com/favicon.ico', { mode: 'no-cors' });
                return {
                    status: 'pass',
                    message: 'DNSè§£ææ­£å¸¸ï¼Œå¯ä»¥æ­£ç¡®è§£æåŸŸå',
                    solution: null
                };
            } catch (e) {
                return {
                    status: 'error',
                    message: 'DNSè§£æå¤±è´¥ï¼Œæ— æ³•è§£æåŸŸå',
                    solution: 'å°è¯•æ›´æ¢DNSæœåŠ¡å™¨ï¼Œå¦‚ä½¿ç”¨8.8.8.8æˆ–114.114.114.114'
                };
            }
        }

        async function checkHTTPConnection() {
            // ç”±äºæµè§ˆå™¨é™åˆ¶ï¼ŒHTTPè¯·æ±‚ä¼šè¢«è‡ªåŠ¨è½¬ä¸ºHTTPS
            return {
                status: 'pass',
                message: 'HTTPè¿æ¥å·²è‡ªåŠ¨å‡çº§ä¸ºHTTPSï¼ˆå®‰å…¨è¿æ¥ï¼‰',
                solution: null
            };
        }

        async function checkHTTPSConnection() {
            if (window.location.protocol === 'https:') {
                return {
                    status: 'pass',
                    message: 'å½“å‰ä½¿ç”¨å®‰å…¨çš„HTTPSè¿æ¥',
                    solution: null
                };
            }
            return {
                status: 'warning',
                message: 'å½“å‰ä½¿ç”¨ä¸å®‰å…¨çš„HTTPè¿æ¥',
                solution: 'å»ºè®®ä½¿ç”¨HTTPSè®¿é—®ä»¥ç¡®ä¿æ•°æ®å®‰å…¨'
            };
        }

        async function checkWebsiteAccess(url, name) {
            const startTime = performance.now();
            try {
                await fetch(url + '/favicon.ico', { 
                    mode: 'no-cors',
                    cache: 'no-store'
                });
                const duration = Math.round(performance.now() - startTime);
                return {
                    status: 'pass',
                    message: `${name}ç½‘ç«™è®¿é—®æ­£å¸¸ï¼Œå“åº”æ—¶é—´ï¼š${duration}ms`,
                    solution: null
                };
            } catch (e) {
                return {
                    status: name === 'è°·æ­Œ' ? 'warning' : 'error',
                    message: `æ— æ³•è®¿é—®${name}ç½‘ç«™`,
                    solution: name === 'è°·æ­Œ' ? 'è°·æ­Œå¯èƒ½éœ€è¦ç¿»å¢™è®¿é—®' : `æ£€æŸ¥${name}ç½‘ç«™æ˜¯å¦è¢«å°ç¦æˆ–æ‚¨çš„ç½‘ç»œè¿æ¥`
                };
            }
        }

        async function checkWebRTC() {
            const supported = !!(window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection);
            return {
                status: supported ? 'pass' : 'warning',
                message: supported ? 'æµè§ˆå™¨æ”¯æŒWebRTCï¼ˆå¯ç”¨äºè§†é¢‘é€šè¯ï¼‰' : 'æµè§ˆå™¨ä¸æ”¯æŒWebRTC',
                solution: supported ? null : 'å»ºè®®å‡çº§æµè§ˆå™¨ä»¥è·å¾—å®Œæ•´çš„ç½‘ç»œåŠŸèƒ½æ”¯æŒ'
            };
        }

        function checkBrowserInfo() {
            const ua = navigator.userAgent;
            const browser = ua.includes('Chrome') ? 'Chrome' :
                           ua.includes('Firefox') ? 'Firefox' :
                           ua.includes('Safari') ? 'Safari' :
                           ua.includes('Edge') ? 'Edge' : 'Unknown';
            
            return {
                status: 'pass',
                message: `æµè§ˆå™¨ï¼š${browser} | å¹³å°ï¼š${navigator.platform}`,
                solution: null
            };
        }

        function checkNetworkType() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            if (connection) {
                const type = connection.effectiveType || 'unknown';
                return {
                    status: type === '4g' ? 'pass' : 'warning',
                    message: `ç½‘ç»œç±»å‹ï¼š${type.toUpperCase()} | é¢„ä¼°é€Ÿåº¦ï¼š${connection.downlink || 'unknown'} Mbps`,
                    solution: type === '4g' ? null : 'å½“å‰ç½‘ç»œé€Ÿåº¦è¾ƒæ…¢ï¼Œå»ºè®®ä½¿ç”¨æ›´å¿«çš„ç½‘ç»œè¿æ¥'
                };
            }
            return {
                status: 'pass',
                message: 'æ— æ³•æ£€æµ‹ç½‘ç»œç±»å‹ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰',
                solution: null
            };
        }

        function checkProxy() {
            // ç®€å•çš„ä»£ç†æ£€æµ‹
            const hasProxy = window.location.hostname !== window.location.host;
            return {
                status: 'pass',
                message: hasProxy ? 'æ£€æµ‹åˆ°å¯èƒ½ä½¿ç”¨äº†ä»£ç†/VPN' : 'æœªæ£€æµ‹åˆ°ä»£ç†æˆ–VPN',
                solution: null
            };
        }

        function checkTimezone() {
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const offset = new Date().getTimezoneOffset();
            const hours = Math.abs(Math.floor(offset / 60));
            const minutes = Math.abs(offset % 60);
            const sign = offset > 0 ? '-' : '+';
            
            return {
                status: 'pass',
                message: `æ—¶åŒºï¼š${timezone} | UTC${sign}${hours}:${minutes.toString().padStart(2, '0')}`,
                solution: null
            };
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºå†å²è®°å½•
        function loadHistory() {
            const history = HistoryManager.getRecent(7);
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            
            if (history.length === 0) {
                historySection.style.display = 'none';
                return;
            }
            
            historySection.style.display = 'block';
            
            // æ›´æ–°ç»Ÿè®¡æ‘˜è¦
            const stats = HistoryManager.getStats();
            if (stats) {
                document.getElementById('statCount').textContent = stats.count;
                document.getElementById('statAvgDownload').textContent = stats.avgDownload + ' Mbps';
                document.getElementById('statAvgUpload').textContent = stats.avgUpload + ' Mbps';
                document.getElementById('statAvgPing').textContent = stats.avgPing + ' ms';
            }
            
            // ç»˜åˆ¶å›¾è¡¨
            drawHistoryChart(history);
            
            // æ˜¾ç¤ºå†å²åˆ—è¡¨
            historyList.innerHTML = history.map((record, index) => {
                const date = new Date(record.timestamp);
                const dateStr = date.toLocaleDateString('zh-CN');
                const timeStr = date.toLocaleTimeString('zh-CN');
                
                return `
                    <div class="history-item">
                        <div>
                            <div class="history-date">${dateStr}</div>
                            <div class="history-time">${timeStr}</div>
                        </div>
                        <div class="history-speeds">
                            <div class="history-speed-item">
                                <div class="history-speed-label">ä¸‹è½½</div>
                                <div class="history-speed-value download">${record.download.toFixed(2)}</div>
                            </div>
                            <div class="history-speed-item">
                                <div class="history-speed-label">ä¸Šä¼ </div>
                                <div class="history-speed-value upload">${record.upload.toFixed(2)}</div>
                            </div>
                            <div class="history-speed-item">
                                <div class="history-speed-label">å»¶è¿Ÿ</div>
                                <div class="history-speed-value ping">${record.ping}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç»˜åˆ¶å†å²è®°å½•å›¾è¡¨
        function drawHistoryChart(history) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            // åè½¬æ•°ç»„ï¼Œè®©æœ€æ—©çš„åœ¨å·¦è¾¹
            const chartData = [...history].reverse();
            
            const labels = chartData.map((record, index) => {
                const date = new Date(record.timestamp);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const downloadData = chartData.map(r => r.download);
            const uploadData = chartData.map(r => r.upload);
            const pingData = chartData.map(r => r.ping);
            
            // é”€æ¯æ—§å›¾è¡¨
            if (historyChart) {
                historyChart.destroy();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ä¸‹è½½é€Ÿåº¦ (Mbps)',
                            data: downloadData,
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#4caf50',
                            yAxisID: 'y'
                        },
                        {
                            label: 'ä¸Šä¼ é€Ÿåº¦ (Mbps)',
                            data: uploadData,
                            borderColor: '#2196f3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#2196f3',
                            yAxisID: 'y'
                        },
                        {
                            label: 'å»¶è¿Ÿ (ms)',
                            data: pingData,
                            borderColor: '#ff9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#ff9800',
                            borderDash: [5, 5],
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'é€Ÿåº¦ (Mbps)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å»¶è¿Ÿ (ms)',
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // æ¸…é™¤å†å²è®°å½•
        function clearHistory() {
            if (confirm('ğŸ—‘ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹é€Ÿå†å²è®°å½•å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                HistoryManager.clear();
                document.getElementById('historySection').style.display = 'none';
                
                // æ˜¾ç¤ºæç¤º
                const btn = document.querySelector('.history-btn.secondary');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… å·²æ¸…é™¤';
                btn.style.background = '#4caf50';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }
        }

        // åˆ·æ–°å†å²è®°å½•
        function refreshHistory() {
            loadHistory();
            
            // æ˜¾ç¤ºæç¤º
            const btn = document.querySelector('.history-btn:not(.secondary)');
            const originalText = btn.textContent;
            btn.textContent = 'âœ… å·²åˆ·æ–°';
            
            setTimeout(() => {
                btn.textContent = originalText;
            }, 1500);
        }

        // é¡µé¢åŠ è½½æ—¶è·å–IPå’ŒåŠ è½½å†å²è®°å½•
        window.addEventListener('load', async () => {
            const networkInfo = await getIPAddress();
            // å­˜å‚¨IPä¿¡æ¯ä¾›åç»­ä½¿ç”¨
            window.networkInfo = networkInfo;
            
            // åŠ è½½å†å²è®°å½•
            loadHistory();
        });
    </script>
</body>
</html>
